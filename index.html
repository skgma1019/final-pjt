<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ê²Œì‹œê¸€ ëª©ë¡ & ê¸€ ì‘ì„±</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    /* ë‚´ë¹„ê²Œì´ì…˜ ë°” ìŠ¤íƒ€ì¼ */
    .nav-bar {
      text-align: right;
      margin-bottom: 20px;
    }
    .nav-bar a {
      margin-left: 10px;
      text-decoration: none;
      color: #fff;
      background: #007bff;
      padding: 8px 12px;
      border-radius: 4px;
    }
    .nav-bar a:hover {
      background: #0056b3;
    }
    /* ê¸€ ì‘ì„± í¼ ìŠ¤íƒ€ì¼ */
    .form-container {
      max-width: 600px;
      margin: 0 auto 30px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .form-container h2 {
      margin-top: 0;
    }
    .form-container label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-container input[type="text"],
    .form-container textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .form-container button {
      background: #007bff;
      border: none;
      color: #fff;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    .form-container button:hover {
      background: #0056b3;
    }
    .message {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    /* ê²Œì‹œê¸€ ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .post {
      background: #fff;
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .post h2 {
      margin: 0 0 10px;
    }
    .post .meta {
      color: #777;
      font-size: 0.9em;
      margin-bottom: 10px;
      
    }
    .comments-section ul {
    list-style: none;
    padding-left: 0;
    margin-top: 10px;
  }
  .comments-section li {
    background: #f2f2f2;
    margin-bottom: 10px;
    padding: 10px 12px;
    border-radius: 6px;
    position: relative;
    font-size: 14px;
    line-height: 1.5;
  }
  .comment-form {
    margin-top: 10px;
  }
  .comment-form input {
    padding: 5px;
    width: 80%;
    border-radius: 3px;
    border: 1px solid #ccc;
  }
  .comment-form button {
    padding: 5px 10px;
    margin-left: 5px;
  }
  .comment-like-btn {
    background-color: #fff !important;
  border: 1px solid #ddd !important;
  border-radius: 20px !important;
  color: #e25555 !important;
  font-weight: bold !important;
  font-size: 13px !important;
  padding: 4px 10px !important;
  margin-top: 5px !important;
  cursor: pointer !important;
  transition: all 0.2s ease-in-out !important; 
  }
  .comment-like-btn:hover {
    background-color: #ffeaea;
  border-color: #ffb3b3;
  }

  .comment-like-btn:active {
    transform: scale(0.95);
    background-color: #ffcccc;
  }
  </style>
</head>
<body>
  <!-- ë‚´ë¹„ê²Œì´ì…˜ ë°” -->
  <div class="nav-bar">
    <a href="login.html">ë¡œê·¸ì¸</a>
    <a href="register.html">íšŒì›ê°€ì…</a>
  </div>

  <!-- ê¸€ ì‘ì„± í¼ -->
  <div class="form-container">
    <h2>ìƒˆ ê¸€ ì‘ì„±í•˜ê¸°</h2>
    <form id="postForm">
      <label for="title">ì œëª©</label>
      <input type="text" id="title" name="title" required>
      
      <label for="content">ë‚´ìš©</label>
      <textarea id="content" name="content" rows="10" required></textarea>
      
      <label for="tags">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
      <input type="text" id="tags" name="tags">
      
      <!-- í…ŒìŠ¤íŠ¸ìš© JWT í† í° ì…ë ¥, ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” localStorage ë˜ëŠ” ì¿ í‚¤ë¥¼ ì‚¬ìš© -->
      <label for="token">JWT í† í° (í…ŒìŠ¤íŠ¸ìš©)</label>
      <input type="text" id="token" name="token" placeholder="í† í° ì…ë ¥ (ì—†ìœ¼ë©´ localStorage ì‚¬ìš©)">
      
      <button type="submit">ê¸€ ì‘ì„±</button>
    </form>
    <div class="message" id="formMessage"></div>
  </div>

  <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
  <h1 style="text-align:center;">ê²Œì‹œê¸€ ëª©ë¡</h1>
  <div id="postsContainer">
    <!-- ê²Œì‹œê¸€ë“¤ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤. -->
  </div>

  <script>
    const API_URL = 'http://localhost:3000';
  
    // ê²Œì‹œê¸€ ì‘ì„± í¼ ì œì¶œ ì²˜ë¦¬
    document.getElementById('postForm').addEventListener('submit', async function(e) {
      e.preventDefault();
  
      const title = document.getElementById('title').value;
      const content = document.getElementById('content').value;
      const tags = document.getElementById('tags').value;
      const tokenInput = document.getElementById('token').value;
      const token = tokenInput || localStorage.getItem('token');
  
      if (!token) {
        document.getElementById('formMessage').textContent = "ë¡œê·¸ì¸ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”.";
        return;
      }
  
      try {
        const response = await fetch(`${API_URL}/articles`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ title, content, tags })
        });
  
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'ê¸€ ì‘ì„± ì‹¤íŒ¨');
        }
  
        document.getElementById('formMessage').textContent = data.message + " (ê¸€ ID: " + data.articleId + ")";
        document.getElementById('postForm').reset();
        fetchPosts();
      } catch (err) {
        document.getElementById('formMessage').textContent = "ì—ëŸ¬: " + err.message;
      }
    });
  
    // ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function fetchPosts() {
      try {
        const response = await fetch(`${API_URL}/articles`);
        const posts = await response.json();
        displayPosts(posts);
      } catch (error) {
        console.error('ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
      }
    }
  
    // ê²Œì‹œê¸€ ë Œë”ë§
    function displayPosts(posts) {
      const container = document.getElementById('postsContainer');
      container.innerHTML = '';
  
      posts.forEach(post => {
        const postElem = document.createElement('div');
        postElem.className = 'post';
  
        postElem.innerHTML = `
          <h2>${post.title}</h2>
          <div class="meta">
            ì‘ì„±ì: ${post.nickname ? post.nickname : 'ì•Œ ìˆ˜ ì—†ìŒ'} | ì‘ì„±ì¼: ${new Date(post.created_at).toLocaleString()} | ì¢‹ì•„ìš”: ${post.likes || 0}
          </div>
          <p>${post.content}</p>
  
          <!-- ëŒ“ê¸€ ëª©ë¡ -->
          <div id="comments-${post.id}" class="comments-section"></div>
  
          <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
          <form class="comment-form" data-article-id="${post.id}">
            <input type="text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" class="comment-input" required />
            <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
            <div class="comment-message"></div>
          </form>
  
          <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
          <button class="like-btn" data-article-id="${post.id}">â¤ï¸ ì¢‹ì•„ìš” (${post.likes || 0})</button>
        `;
  
        container.appendChild(postElem);
  
        const commentForm = postElem.querySelector(`form[data-article-id="${post.id}"]`);
        if (commentForm) {
          commentForm.addEventListener('submit', handleCommentSubmit);
        }
  
        fetchComments(post.id);
      });
    }
  
    // ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function fetchComments(articleId) {
  try {
    const res = await fetch(`${API_URL}/articles/${articleId}/comments`);
    const comments = await res.json();

    const commentSection = document.getElementById(`comments-${articleId}`);
    commentSection.innerHTML = `<strong>ğŸ’¬ ëŒ“ê¸€</strong><ul>${comments.map(c => `
      <li>
        ğŸ‘¤ ${c.nickname ? c.nickname : 'ì•Œ ìˆ˜ ì—†ìŒ'}: ${c.content} (${c.created_at.split('T')[0]})<br />
        <button class="comment-like-btn" data-comment-id="${c.id}">â¤ï¸ ${c.likes || 0}</button>
      </li>
    `).join('')}</ul>`;
  } catch (err) {
    console.error('ëŒ“ê¸€ ë¡œë”© ì‹¤íŒ¨:', err);
  }
}

  
    // ëŒ“ê¸€ ì‘ì„± ì²˜ë¦¬
    async function handleCommentSubmit(e) {
      e.preventDefault();
  
      const form = e.target;
      const articleId = form.dataset.articleId;
      const input = form.querySelector('.comment-input');
      const message = form.querySelector('.comment-message');
      const token = localStorage.getItem('token');
  
      if (!token) {
        message.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        return;
      }
  
      try {
        const res = await fetch(`${API_URL}/articles/${articleId}/comments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ content: input.value })
        });
  
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
  
        message.textContent = 'âœ… ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ';
        input.value = '';
        fetchComments(articleId);
      } catch (err) {
        message.textContent = 'âŒ ' + err.message;
      }
    }
  
    // âœ… ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ (ì¤‘ë³µ ì œê±°ë¨)
    document.addEventListener('click', async function(e) {
      if (e.target.classList.contains('like-btn')) {
        const articleId = e.target.dataset.articleId;
        const token = localStorage.getItem('token');
        if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
          return;
        }
  
        try {
          const res = await fetch(`${API_URL}/articles/${articleId}/like`, {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });
  
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
  
          alert(data.message); // ì¢‹ì•„ìš” ì¶”ê°€ or ì·¨ì†Œ ê²°ê³¼ ë©”ì‹œì§€
          fetchPosts(); // ì¢‹ì•„ìš” ìˆ˜ ë°˜ì˜ ìœ„í•´ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        } catch (err) {
          alert('âŒ ' + err.message);
        }
      }
    });
  
    document.addEventListener('click', async function(e) {
  if (e.target.classList.contains('comment-like-btn')) {
    const commentId = e.target.dataset.commentId;
    const token = localStorage.getItem('token');
    if (!token) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');

    try {
      const res = await fetch(`${API_URL}/comments/${commentId}/like`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      alert(data.message);
      fetchPosts(); // ì¢‹ì•„ìš” ìˆ˜ ë°˜ì˜ì„ ìœ„í•´ ì „ì²´ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    } catch (err) {
      alert('âŒ ' + err.message);
    }
  }
});

    // ì´ˆê¸° ë¡œë”©
    document.addEventListener('DOMContentLoaded', fetchPosts);
  </script>
  
</body>
</html>
